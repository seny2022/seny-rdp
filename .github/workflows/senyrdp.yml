name: RDP (Stable)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360     # ÙŠÙØ¶Ù„ Ù…ÙØªÙˆØ­ Ø­ØªÙ‰ 6 Ø³Ø§Ø¹Ø§Øª

    steps:
    ##################################################################
    # 1) ØªÙ†Ø²ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ ngrok
    ##################################################################
    - name: Install ngrok
      shell: pwsh
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN

    ##################################################################
    # 2) ØªÙØ¹ÙŠÙ„ RDP + ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© + Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙˆØ±Øª
    ##################################################################
    - name: Enable & start RDP
      shell: pwsh
      run: |
        $user = 'kamel123'
        $pass = 'MyStrong123'

        # Ø£) Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù† + Remote Desktop Users
        net user $user $pass /add
        net localgroup administrators         $user /add
        net localgroup "Remote Desktop Users" $user /add

        # Ø¨) ØªÙØ¹ÙŠÙ„ RDP Ø¹Ø¨Ø± Ø§Ù„Ø±ÙŠØ¬ÙŠØ³ØªØ±ÙŠ + Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # Ø¬) Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ ÙˆØªØ´ØºÙŠÙ„Ù‡Ø§
        sc.exe config TermService start= auto
        Start-Service TermService

        # Ø¯) Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¯ Ù…Ø§ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª 3389 ÙÙ‰ ÙˆØ¶Ø¹ LISTENING
        $tries = 30
        for ($i=1; $i -le $tries; $i++) {
          if (Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue) {
            Write-Host "âœ… RDP service is listening on 3389"
            break
          }
          Start-Sleep 1
          if ($i -eq $tries) {
            Write-Error "âŒ RDP port 3389 is NOT listening."
            exit 1
          }
        }

    ##################################################################
    # 3) ØªØ´ØºÙŠÙ„ ngrok ÙÙ‰ Ø§Ù„Ø®Ù„ÙÙŠØ© + Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø£Ù…Ø§Ù†
    ##################################################################
    - name: Start ngrok tunnel
      id: ng
      shell: pwsh
      run: |
        Start-Process .\ngrok.exe -ArgumentList "tcp 3389" -WindowStyle Hidden
        # Ù†Ù…Ù‡Ù‘ÙÙ„ ngrok ÙŠØ¬Ù‡Ù‘Ø²
        Start-Sleep 6

        # Ù†Ø­Ø§ÙˆÙ„ Ù„ØºØ§ÙŠØ© 30 Ø«Ø§Ù†ÙŠØ© Ù†Ø¬ÙŠØ¨ Ø§Ù„Ù€ URL
        $url = $null
        for ($i=1; $i -le 30; $i++) {
          try {
            $url = (Invoke-RestMethod http://127.0.0.1:4040/api/tunnels).tunnels[0].public_url
            if ($url) { break }
          } catch { }
          Start-Sleep 1
        }
        if (-not $url) { Write-Error "âŒ ngrok URL not found."; exit 1 }

        Write-Host "ğŸ‰ğŸ”—  RDP URL: $url"
        # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù€ output
        "url=$url" | Out-File -FilePath $Env:GITHUB_OUTPUT -Encoding utf8

    ##################################################################
    # 4) Ù…Ù„Ø®Øµ Ù„Ù„ÙˆØ¬
    ##################################################################
    - name: Finished
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "Copy this into Remote Desktop (mstsc):"
        Write-Host "  ${{ steps.ng.outputs.url }}  (host:port)"
        Write-Host ""
        Write-Host "User    : kamel123"
        Write-Host "Password: MyStrong123"
