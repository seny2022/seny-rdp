name: RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1) ØªÙ†Ø²ÙŠÙ„ ngrok ÙˆÙÙƒÙ‘Ù‡ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†
    - name: Download and configure ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        $env:PATH += ";$PWD"          # Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ùˆ Ø§Ø­ØªØ¬Øª ØªØ´ØºÙ‘Ù„Ù‡ Ù…Ù† Ø£ÙŠ Ù…Ø³Ø§Ø±
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN

    # 2) ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ RDP ÙˆØªØ´ØºÙŠÙ„ ngrok ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø«Ù… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    - name: Enable RDP and start ngrok tunnel
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
        net user kamel123 MyStrong123 /add
        net localgroup administrators kamel123 /add

        # ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ RDP ÙˆÙØªØ­ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # ØªØ´ØºÙŠÙ„ ngrok ÙƒØ¹Ù…Ù„ÙŠØ© Ø®Ù„ÙÙŠØ©
        Start-Process .\ngrok.exe -ArgumentList "tcp 3389" -WindowStyle Hidden

        # Ø§Ù†ØªØ¸Ø§Ø± ngrok ÙŠØ¬Ù‡Ù‘Ø² ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Tunnel
        $maxRetries = 20   # Ø­ÙˆØ§Ù„ÙŠ 20 Ø«Ø§Ù†ÙŠØ©
        for ($i = 0; $i -lt $maxRetries; $i++) {
          try {
            $tunnelData = Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels
            if ($tunnelData.tunnels -and $tunnelData.tunnels[0].public_url) {
              $url = $tunnelData.tunnels[0].public_url
              Write-Host ""
              Write-Host "ğŸ‰ğŸ”—  RDP URL: $url"
              exit 0
            }
          } catch {
            # Ù„Ø³Ù‡ Ù…ÙÙŠØ´ API â€¦ Ù‡Ù†Ø³ØªÙ†Ù‰
          }
          Start-Sleep -Seconds 1
        }

        Write-Error "âŒ  Failed to retrieve ngrok URL within allotted time."
        exit 1
