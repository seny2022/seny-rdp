name: Free RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360         # Ø£Ù‚ØµÙ‰ Ù…Ø¯Ø© = 6 Ø³Ø§Ø¹Ø§Øª

    steps:
    # 1) Ù†Ø²Ù‘Ù„ ngrok ÙˆØ³Ø¬Ù‘Ù„ Ø§Ù„ØªÙˆÙƒÙÙ†
    - name: Install ngrok
      shell: pwsh
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        .\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN

    # 2) ÙØ¹Ù‘ÙÙ„ RDPØŒ Ø§ÙØªØ­ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„ØŒ Ø´ØºÙ‘Ù„ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø§Ø³ØªÙ†Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª ÙŠÙ€ Listen
    - name: Enable RDP & start service
      shell: pwsh
      run: |
        $user = 'kamel123'
        $pass = 'MyStrong123'
        net user $user $pass /add
        net localgroup administrators         $user /add
        net localgroup "Remote Desktop Users" $user /add
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        sc.exe config TermService start= auto
        Start-Service TermService
        # Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¯ Ù…Ø§ Ø§Ù„Ø¨ÙˆØ±Øª 3389 ÙŠØ´ØªØºÙ„
        for ($i=0; $i -lt 30; $i++) {
          if (Get-NetTCPConnection -LocalPort 3389 -State Listen -ErrorAction SilentlyContinue) { break }
          Start-Sleep 1
          if ($i -eq 29) { Write-Error "RDP port Ù„Ù… ÙŠÙØªØ­"; exit 1 }
        }

    # 3) Ø´ØºÙ‘Ù„ ngrokØŒ Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø§Ø·Ø¨Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù„ÙˆØ¬
    - name: Start ngrok tunnel
      id: ngrok
      shell: pwsh
      run: |
        Start-Process .\ngrok.exe -ArgumentList "tcp 3389" -WindowStyle Hidden
        Start-Sleep 6
        for ($i=0; $i -lt 30; $i++) {
          try {
            $u = (Invoke-RestMethod http://127.0.0.1:4040/api/tunnels).tunnels[0].public_url
            if ($u) { "ğŸ‰ğŸ”—  RDP URL: $u" | Write-Host; "url=$u" | Out-File $Env:GITHUB_OUTPUT -Encoding utf8; break }
          } catch { }
          Start-Sleep 1
        }

    # 4) Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ job Ø­ÙŠ  (ÙŠÙ…ÙƒÙ†Ùƒ ÙˆÙ‚ÙÙ‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…ØªÙ‰ Ø§Ù†ØªÙ‡ÙŠØª)
    - name: Keep session alive
      shell: pwsh
      run: |
        Write-Host "ğŸ”„ Session alive. Ø¹Ù†Ø¯Ù…Ø§ ØªÙ†ØªÙ‡ÙŠØŒ Ø§Ø¶ØºØ· Cancel Ù„Ù„Ù€ job Ù…Ù† ØµÙØ­Ø© Actions."
        while ($true) { Start-Sleep 300 }
