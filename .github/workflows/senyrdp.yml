name: RDP (Windows Runner)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360   # Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ‚Ø¯Ø± ØªØ¹ÙŠØ´ Ù„Ø­Ø¯ 6 Ø³Ø§Ø¹Ø§Øª (Ø­Ø¯ GitHub Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ)

    steps:
    #################################################################
    # 1) Ù†Ù†Ø²Ù‘Ù„ ngrok ÙˆÙ†ÙØ¹Ù‘Ù„ Ø§Ù„ØªÙˆÙƒÙÙ†
    #################################################################
    - name: Download & configure ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      shell: pwsh
      run: |
        # ØªØ­Ù…ÙŠÙ„ ÙˆØªÙØ±ÙŠØº ngrok
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip `
                         -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath .
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙÙ†
        .\ngrok.exe authtoken $env:NGROK_AUTH_TOKEN

    #################################################################
    # 2) ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ RDP + ÙØªØ­ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„ + ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
    #################################################################
    - name: Enable RDP, open firewall & start ngrok
      id: rdp
      shell: pwsh
      run: |
        #############################################################
        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø¯Ù‘Ù„ Ù„Ùˆ Ø­Ø§Ø¨Ø¨)
        #############################################################
        $user     = 'kamel123'
        $password = 'MyStrong123'

        #############################################################
        # Ø£) Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†
        #############################################################
        net user $user $password /add
        net localgroup administrators $user /add

        #############################################################
        # Ø¨) ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ù€ RDP + ÙØªØ­ Ø§Ù„ÙØ§ÙŠØ±ÙˆÙˆÙ„
        #############################################################
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                         -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        #############################################################
        # Ø¬) ØªØ´ØºÙŠÙ„ ngrok ÙƒÙ†ÙÙ‚ TCP Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª 3389 (Ø®Ù„ÙÙŠØ©)
        #############################################################
        Start-Process .\ngrok.exe -ArgumentList "tcp 3389" -WindowStyle Hidden

        #############################################################
        # Ø¯) Ù†Ù†ØªØ¸Ø± Ù„Ø­Ø¯ Ù…Ø§ Ø§Ù„Ù€ API ÙŠØ¨Ù‚Ù‰ Ø¬Ø§Ù‡Ø² ÙˆÙ†Ø·Ø¨Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Tunnel
        #############################################################
        $maxTries   = 30  # Ø«ÙˆØ§Ù†ÙŠ Ø§Ù†ØªØ¸Ø§Ø± (â‰ˆ 30 Ø«Ø§Ù†ÙŠØ©)
        $tunnelUrl  = $null

        for ($i = 1; $i -le $maxTries; $i++) {
          try {
            $json = Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels
            if ($json.tunnels -and $json.tunnels[0].public_url) {
              $tunnelUrl = $json.tunnels[0].public_url
              break
            }
          } catch {
            # API Ù„Ø³Ù‡ Ù…Ø´ Ø¬Ø§Ù‡Ø²
          }
          Start-Sleep -Seconds 1
        }

        if (-not $tunnelUrl) {
          Write-Error "ngrok tunnel did not start in allotted time."
          Exit 1
        }

        #############################################################
        # Ù‡Ù€) Ù†Ø·Ø¨Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„Ù„ÙˆØ¬ ÙˆÙ†ØµØ¯Ù‘Ø±Ù‡ ÙƒÙ€ Output
        #############################################################
        "ğŸ‰ğŸ”— RDP URL: $tunnelUrl" | Write-Host
        echo "::set-output name=url::$tunnelUrl"

    #################################################################
    # 3) Ø±Ø³Ø§Ù„Ø© Ø®ØªØ§Ù…ÙŠØ© Ù…Ø®ØªØµØ±Ø©
    #################################################################
    - name: Finished
      if: success()
      run: |
        Write-Host ""
        Write-Host "âœ…  Everything is ready. Copy the RDP URL above into"
        Write-Host "   Remote Desktop (mstsc) using the format:"
        Write-Host "       <host>:<port>"
        Write-Host ""
        Write-Host "   Username : kamel123"
        Write-Host "   Password : MyStrong123"
